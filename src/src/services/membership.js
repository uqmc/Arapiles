import axios from "axios";

import { authenticationService } from "../services/authentication.js"

import { differenceInDays, add, parse, isFuture } from "date-fns";

async function memberships() {
    const response = await axios.get(process.env.GATSBY_CMS_HOST + "/grampians/memberships")
    .then(response => {
        return response;
    }).catch(error => {
        return false;
    })

    return response;
}

async function pay(membershipID, token) {
    const response = await axios.put(process.env.GATSBY_CMS_HOST + "/grampians/memberships/pay", {
        membershipID: membershipID,
        token: token
    }, {
        headers: authenticationService.getAuthHeader()
    }).then(response => {
        return true;
    }).catch(error => {
        return error.response.data.message;
    })

    return response; 
}

function daysLeft(user) {
    const currentMembershipStartDate = parse(user.currentMembershipStartDate, 'yyyy-MM-dd', new Date());
    const currentMembershipEndDate = add(currentMembershipStartDate, { days: user.currentMembershipLength });
    return parseInt(differenceInDays(currentMembershipEndDate, new Date()));
}

function isValid(user) {
    const currentMembershipStartDate = parse(user.currentMembershipStartDate, 'yyyy-MM-dd', new Date());
    const currentMembershipEndDate = add(currentMembershipStartDate, { days: user.currentMembershipLength });
    return isFuture(currentMembershipEndDate);
}

export const membershipService = {
    memberships,
    pay,
    isValid,
    daysLeft,
};